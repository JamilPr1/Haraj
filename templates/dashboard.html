<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haraj Scraper Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            border: none;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .listing-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: box-shadow 0.2s;
            margin-bottom: 1rem;
            padding: 1.25rem;
            overflow: hidden;
        }
        
        .listing-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .listing-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .listing-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .badge-custom {
            padding: 0.4em 0.7em;
            font-weight: 500;
            font-size: 0.85rem;
            white-space: nowrap;
            display: inline-block;
        }
        
        .phone-number {
            color: #198754;
            font-weight: 600;
            font-size: 0.95rem;
            word-break: break-word;
        }
        
        .contact-section {
            min-height: 80px;
            overflow: hidden;
        }
        
        .info-section {
            min-height: 80px;
            overflow: hidden;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        
        .action-buttons .btn {
            white-space: nowrap;
            text-align: center;
        }
        
        .progress-container {
            background-color: #e9ecef;
            border-radius: 0.375rem;
            height: 8px;
        }
        
        .progress-bar-custom {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .stats-row {
            margin-bottom: 1.5rem;
        }
        
        .actions-card {
            margin-bottom: 1.5rem;
        }
        
        .listing-content {
            display: grid;
            grid-template-columns: 1fr 200px 180px 140px;
            gap: 1.5rem;
            align-items: start;
        }
        
        .listing-main-content {
            min-width: 0;
            overflow: hidden;
        }
        
        .listing-contact-section {
            width: 200px;
            flex-shrink: 0;
        }
        
        .listing-info-section {
            width: 180px;
            flex-shrink: 0;
        }
        
        .listing-actions-section {
            width: 140px;
            flex-shrink: 0;
        }
        
        @media (max-width: 1200px) {
            .listing-content {
                grid-template-columns: 1fr 180px 160px 130px;
                gap: 1rem;
            }
            
            .listing-contact-section {
                width: 180px;
            }
            
            .listing-info-section {
                width: 160px;
            }
            
            .listing-actions-section {
                width: 130px;
            }
        }
        
        @media (max-width: 992px) {
            .listing-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .listing-contact-section,
            .listing-info-section,
            .listing-actions-section {
                width: 100%;
            }
            
            .action-buttons {
                flex-direction: row;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Haraj Scraper Dashboard</span>
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="bi bi-gear"></i> الإعدادات
            </button>
        </div>
    </nav>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">إعدادات الاستخراج</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label for="settingsUsername" class="form-label">اسم المستخدم / البريد الإلكتروني</label>
                            <input type="text" class="form-control" id="settingsUsername" 
                                   placeholder="أدخل اسم المستخدم أو البريد الإلكتروني" 
                                   value="{{ config.username if config else '' }}">
                            <small class="form-text text-muted">اسم المستخدم أو البريد الإلكتروني لحساب حراج</small>
                        </div>
                        <div class="mb-3">
                            <label for="settingsPassword" class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" id="settingsPassword" 
                                   placeholder="أدخل كلمة المرور">
                            <small class="form-text text-muted">اتركه فارغاً إذا كنت لا تريد تغيير كلمة المرور</small>
                        </div>
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle"></i> 
                            <strong>ملاحظة:</strong> يتم حفظ بيانات الاعتماد محلياً. استخدم هذه الميزة لتسجيل الدخول تلقائياً عند الاستخراج للحصول على معلومات الاتصال.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">حفظ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-4">
        <!-- Statistics Cards -->
        <div class="row g-3 stats-row">
            <div class="col-md-4 col-lg-2">
                <div class="card stat-card shadow-sm">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ stats.total }}</div>
                        <p class="text-muted mb-0 small">إجمالي الإعلانات</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="card stat-card shadow-sm">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ stats.with_contact }}</div>
                        <p class="text-muted mb-0 small">مع معلومات الاتصال</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="card stat-card shadow-sm">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ stats.cities|length if stats.cities else 0 }}</div>
                        <p class="text-muted mb-0 small">مدن مختلفة</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="card stat-card shadow-sm">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ stats.with_images if stats.with_images else 0 }}</div>
                        <p class="text-muted mb-0 small">إجمالي الصور</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="card stat-card shadow-sm">
                    <div class="card-body text-center">
                        <div class="stat-number">{{ stats.with_prices if stats.with_prices else 0 }}</div>
                        <p class="text-muted mb-0 small">مع الأسعار</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-2">
                <div class="card stat-card shadow-sm bg-primary text-white">
                    <div class="card-body text-center">
                        <div class="stat-number text-white">{{ listings|length if listings else 0 }}</div>
                        <p class="mb-0 small opacity-75">الإعلانات المعروضة</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Section -->
        <div class="card shadow-sm actions-card">
            <div class="card-body">
                <div class="row align-items-center g-3">
                    <div class="col-md-auto">
                        <label for="max_listings" class="form-label mb-0 fw-bold">عدد الإعلانات:</label>
                    </div>
                    <div class="col-md-auto">
                        <input type="number" id="max_listings" class="form-control" min="1" max="100" value="10" style="width: 100px;">
                    </div>
                    <div class="col-md-auto">
                        <button type="button" id="startScrapingBtn" class="btn btn-primary">
                            <i class="bi bi-play-fill"></i> بدء الاستخراج
                        </button>
                        <button type="button" id="stopScrapingBtn" class="btn btn-danger" style="display: none;">
                            <i class="bi bi-stop-fill"></i> إيقاف
                        </button>
                    </div>
                    <div class="col-md-auto ms-auto">
                        <a href="/download/json" class="btn btn-outline-primary">
                            <i class="bi bi-download"></i> تحميل JSON
                        </a>
                        <a href="/download/csv" class="btn btn-outline-success">
                            <i class="bi bi-file-earmark-spreadsheet"></i> تحميل CSV
                        </a>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div id="scrapingStatus" class="mt-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="statusText" class="text-primary fw-bold">جارٍ الاستخراج...</span>
                        <span id="progressText" class="text-muted small">0 / 0</span>
                    </div>
                    <div class="progress-container">
                        <div id="progressBar" class="progress-bar-custom" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listings List -->
        {% if listings %}
        <div class="row">
            <div class="col-12">
                {% for listing in listings %}
                <div class="listing-item">
                    <div class="listing-content">
                        <!-- Main Content -->
                        <div class="listing-main-content">
                            <h5 class="listing-title mb-2">{{ listing.title }}</h5>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                {% if listing.city %}
                                <span class="badge bg-info badge-custom">
                                    <i class="bi bi-geo-alt"></i> {{ listing.city }}
                                </span>
                                {% endif %}
                                {% if listing.category %}
                                <span class="badge bg-warning text-dark badge-custom">
                                    <i class="bi bi-tag"></i> {{ listing.category }}
                                </span>
                                {% endif %}
                                {% if listing.price %}
                                <span class="badge bg-success badge-custom">
                                    <i class="bi bi-currency-exchange"></i> {{ listing.price }}
                                </span>
                                {% endif %}
                            </div>
                            {% if listing.description %}
                            <p class="listing-description mb-0">
                                {{ listing.description[:200] }}{% if listing.description|length > 200 %}...{% endif %}
                            </p>
                            {% endif %}
                        </div>
                        
                        <!-- Contact Information -->
                        <div class="listing-contact-section contact-section">
                            {% if listing.contact_info and listing.contact_info.phone_numbers %}
                            <div>
                                <small class="text-muted d-block mb-2 fw-semibold">معلومات الاتصال:</small>
                                {% for phone in listing.contact_info.phone_numbers %}
                                <div class="phone-number mb-2">{{ phone }}</div>
                                {% endfor %}
                                {% if listing.contact_info.whatsapp_link %}
                                <a href="{{ listing.contact_info.whatsapp_link }}" target="_blank" class="text-success text-decoration-none d-block mb-2 small">
                                    <i class="bi bi-whatsapp"></i> واتساب
                                </a>
                                {% endif %}
                                {% if listing.contact_info.emails %}
                                <div class="text-muted small mb-2">
                                    <i class="bi bi-envelope"></i> <span style="word-break: break-word;">{{ listing.contact_info.emails[0] }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="text-muted small">لا توجد معلومات اتصال</div>
                            {% endif %}
                        </div>
                        
                        <!-- Seller Info -->
                        <div class="listing-info-section info-section">
                            <div class="small text-muted">
                                <div class="mb-2 d-flex align-items-start">
                                    <i class="bi bi-person me-1 flex-shrink-0"></i>
                                    <span style="word-break: break-word;">{{ listing.seller_name or 'غير معروف' }}</span>
                                </div>
                                <div class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-images me-1 flex-shrink-0"></i>
                                    <span>{{ listing.images|length }} صورة</span>
                                </div>
                                {% if listing.posted_time %}
                                <div class="mb-2 d-flex align-items-center">
                                    <i class="bi bi-clock me-1 flex-shrink-0"></i>
                                    <span>{{ listing.posted_time }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="listing-actions-section">
                            <div class="action-buttons">
                                <a href="/listing/{{ listing.listing_id }}" class="btn btn-primary btn-sm w-100">
                                    <i class="bi bi-eye"></i> عرض
                                </a>
                                <a href="{{ listing.url }}" target="_blank" class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="bi bi-box-arrow-up-right"></i> رابط
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="card shadow-sm">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #dee2e6;"></i>
                <h4 class="mt-3 text-muted">لا توجد بيانات</h4>
                <p class="text-muted">لم يتم العثور على أي إعلانات مستخرجة</p>
                <p class="text-muted small">قم بتشغيل السكريبت أولاً لجمع البيانات</p>
                <code class="d-block mt-3 p-3 bg-light rounded">
                    python haraj_scraper_selenium.py --category "https://haraj.com.sa/tags/حراج السيارات" --max-listings 20
                </code>
            </div>
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let statusInterval;

        function startScraping(event) {
            // Prevent any default form submission or page refresh
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const maxListings = document.getElementById('max_listings').value;
            const startBtn = document.getElementById('startScrapingBtn');
            const stopBtn = document.getElementById('stopScrapingBtn');
            const statusDiv = document.getElementById('scrapingStatus');

            // Disable button immediately to prevent multiple clicks
            startBtn.disabled = true;
            stopBtn.style.display = 'inline-block';
            statusDiv.style.display = 'block';
            document.getElementById('statusText').innerText = 'جارٍ بدء الاستخراج...';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').innerText = '0 / 0';

            // Use fetch with proper error handling
            fetch('/api/start-scraping', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ max_listings: parseInt(maxListings), category_url: 'https://haraj.com.sa/tags/حراج السيارات' }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert('خطأ: ' + data.error);
                    startBtn.disabled = false;
                    stopBtn.style.display = 'none';
                    statusDiv.style.display = 'none';
                } else {
                    statusInterval = setInterval(updateScrapingStatus, 2000);
                }
            })
            .catch(error => {
                console.error('Error starting scraping:', error);
                const errorMsg = error.error || error.message || 'فشل بدء الاستخراج.';
                alert('خطأ: ' + errorMsg);
                startBtn.disabled = false;
                stopBtn.style.display = 'none';
                statusDiv.style.display = 'none';
            });
            
            return false; // Prevent any form submission
        }
        
        // Attach event listeners to prevent any form submission or page refresh
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startScrapingBtn');
            const stopBtn = document.getElementById('stopScrapingBtn');
            
            if (startBtn) {
                // Remove any existing onclick handlers to avoid conflicts
                startBtn.setAttribute('onclick', '');
                
                // Add event listener with capture phase
                startBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    startScraping(e);
                    return false;
                }, true);
            }
            
            if (stopBtn) {
                // Remove any existing onclick handlers to avoid conflicts
                stopBtn.setAttribute('onclick', '');
                
                // Add event listener with capture phase
                stopBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    stopScraping(e);
                    return false;
                }, true);
            }
            
            // Prevent any form submission that might contain these buttons
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form && (form.contains(startBtn) || form.contains(stopBtn))) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
        });

        function stopScraping(event) {
            // Prevent any default form submission
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            fetch('/api/stop-scraping', {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                if (!data.status.is_running) {
                    clearInterval(statusInterval);
                    document.getElementById('startScrapingBtn').disabled = false;
                    document.getElementById('stopScrapingBtn').style.display = 'none';
                    document.getElementById('scrapingStatus').style.display = 'none';
                    // Only reload if scraping completed successfully (not on error)
                    if (!data.error && data.progress > 0) {
                        // Small delay before reload to show completion message
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                }
            })
            .catch(error => {
                console.error('Error stopping scraping:', error);
                alert('فشل إيقاف الاستخراج.');
            });
            
            return false; // Prevent any form submission
        }

        function updateScrapingStatus() {
            fetch('/api/scraping-status')
                .then(response => response.json())
                .then(data => {
                    const statusText = document.getElementById('statusText');
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const startBtn = document.getElementById('startScrapingBtn');
                    const stopBtn = document.getElementById('stopScrapingBtn');
                    const statusDiv = document.getElementById('scrapingStatus');

                    if (data.is_running) {
                        statusText.innerText = data.current_listing || 'جارٍ الاستخراج...';
                        const progress = data.total > 0 ? (data.progress / data.total) * 100 : 0;
                        progressBar.style.width = `${progress}%`;
                        progressText.innerText = `${data.progress} / ${data.total}`;
                        startBtn.disabled = true;
                        stopBtn.style.display = 'inline-block';
                        statusDiv.style.display = 'block';
                    } else {
                        clearInterval(statusInterval);
                        startBtn.disabled = false;
                        stopBtn.style.display = 'none';
                        statusDiv.style.display = 'none';
                        if (data.error) {
                            alert('انتهى الاستخراج مع خطأ: ' + data.error);
                        }
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error fetching scraping status:', error);
                    clearInterval(statusInterval);
                    document.getElementById('startScrapingBtn').disabled = false;
                    document.getElementById('stopScrapingBtn').style.display = 'none';
                    document.getElementById('scrapingStatus').style.display = 'none';
                });
        }

        function saveSettings() {
            const username = document.getElementById('settingsUsername').value.trim();
            const password = document.getElementById('settingsPassword').value.trim();
            
            fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('تم حفظ الإعدادات بنجاح');
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                    modal.hide();
                    // Clear password field
                    document.getElementById('settingsPassword').value = '';
                } else {
                    alert('فشل حفظ الإعدادات: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                alert('حدث خطأ أثناء حفظ الإعدادات');
            });
        }

        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('settingsUsername').value = data.username || '';
                    // Don't load password for security
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load scraping status
            fetch('/api/scraping-status')
                .then(response => response.json())
                .then(data => {
                    if (data.is_running) {
                        document.getElementById('startScrapingBtn').disabled = true;
                        document.getElementById('stopScrapingBtn').style.display = 'inline-block';
                        document.getElementById('scrapingStatus').style.display = 'block';
                        statusInterval = setInterval(updateScrapingStatus, 2000);
                    }
                });
            
            // Load settings when modal is opened
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.addEventListener('show.bs.modal', function () {
                    loadSettings();
                });
            }
        });
    </script>
</body>
</html>
